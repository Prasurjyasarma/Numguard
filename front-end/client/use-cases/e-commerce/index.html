<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShopEasy - Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #7C7CE5;
            --secondary: #5f3dc4;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --error: #dc3545;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 450px;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .logo {
            margin-bottom: 30px;
        }
        
        .logo i {
            font-size: 48px;
            color: var(--primary);
        }
        
        h1 {
            color: var(--dark);
            margin-bottom: 30px;
            font-weight: 600;
        }
        
        .input-group {
            margin-bottom: 25px;
            position: relative;
        }
        
        .input-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #adb5bd;
            font-size: 18px;
        }
        
        input {
            width: 100%;
            padding: 15px 15px 15px 45px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
        }
        
        input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 4px 6px rgba(132, 86, 246, 0.2);
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(132, 86, 246, 0.2);
        }
        
        button:hover {
            background-color: #4747DA;
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .screen {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .active {
            display: block;
        }
        
        .message {
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loader {
            border: 4px solid rgba(255, 87, 34, 0.2);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        
        .timer {
            font-size: 14px;
            color: #6c757d;
            margin-top: 15px;
        }
        
        .resend {
            background: none;
            border: none;
            color: var(--secondary);
            cursor: pointer;
            font-size: 14px;
            margin-top: 15px;
            padding: 0;
            text-decoration: underline;
            width: auto;
            box-shadow: none;
        }
        
        .resend:hover {
            color: #4c3299;
            background: none;
            transform: none;
        }
        
        .resend:disabled {
            color: #adb5bd;
            cursor: not-allowed;
            text-decoration: none;
        }
        
        .otp-inputs {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
        }
        
        .otp-inputs input {
            width: 50px;
            height: 60px;
            font-size: 24px;
            text-align: center;
            border-radius: 8px;
            margin: 0 5px;
            padding: 0;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .progress-bar {
            position: relative;
            height: 5px;
            background-color: #e9ecef;
            border-radius: 3px;
            margin: 30px 0;
            overflow: hidden;
        }
        
        .progress-bar .progress {
            position: absolute;
            height: 100%;
            background-color: var(--primary);
            transition: width 0.5s ease;
            border-radius: 3px;
        }
        
        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #adb5bd;
            font-size: 16px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .step.active .step-icon {
            background-color: var(--primary);
            color: white;
        }
        
        .step.completed .step-icon {
            background-color: var(--success);
            color: white;
        }
        
        .step-label {
            font-size: 12px;
            color: #6c757d;
        }
        
        .step.active .step-label {
            color: var(--primary);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Progress Indicator -->
        <div class="steps">
            <div class="step active" id="stepPhone">
                <div class="step-icon"><i class="fas fa-phone"></i></div>
                <div class="step-label">Phone</div>
            </div>
            <div class="step" id="stepOTP">
                <div class="step-icon"><i class="fas fa-key"></i></div>
                <div class="step-label">Verify</div>
            </div>
            <div class="step" id="stepSuccess">
                <div class="step-icon"><i class="fas fa-check"></i></div>
                <div class="step-label">Done</div>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress" style="width: 33%;"></div>
        </div>
        
        <!-- Logo -->
        <div class="logo">
            <i class="fas fa-shopping-bag"></i>
        </div>
        
        <!-- Phone Number Screen -->
        <div id="phoneScreen" class="screen active">
            <h1>Welcome to ShopEasy</h1>
            <p>Enter your phone number to continue shopping</p>
            <div class="input-group">
                <i class="fas fa-phone"></i>
                <input type="tel" id="phoneNumber" placeholder="Your phone number" required>
            </div>
            <button id="sendOtpBtn">Continue <i class="fas fa-arrow-right"></i></button>
            <div class="message" id="phoneMessage"></div>
        </div>

        <!-- OTP Verification Screen -->
        <div id="otpScreen" class="screen">
            <h1>Verify Your Number</h1>
            <p>We've sent an OTP to <span id="displayPhone" style="font-weight: 600;"></span></p>
            
            <div class="otp-inputs">
                <input type="text" maxlength="1" id="otp1" class="otp-input">
                <input type="text" maxlength="1" id="otp2" class="otp-input">
                <input type="text" maxlength="1" id="otp3" class="otp-input">
                <input type="text" maxlength="1" id="otp4" class="otp-input">
            </div>
            
            <button id="verifyOtpBtn">Verify OTP</button>
            <div class="message" id="otpMessage"></div>
            
            <div class="timer" id="resendTimer">Resend OTP in <span id="countdownTimer">60</span>s</div>
            <button id="resendOtpBtn" class="resend" disabled>Resend OTP</button>
        </div>

        <!-- Success Screen -->
        <div id="successScreen" class="screen">
            <h1>Verification Successful</h1>
            <i class="fas fa-check-circle" style="font-size: 60px; color: var(--success); margin: 20px 0;"></i>
            <p>Your phone number has been verified successfully!</p>
            <p>Redirecting to shopping...</p>
            <div class="loader" style="display: block;"></div>
        </div>

        <!-- Loader -->
        <div id="loader" class="loader"></div>
    </div>

    <script>
        // DOM Elements
        const phoneScreen = document.getElementById('phoneScreen');
        const otpScreen = document.getElementById('otpScreen');
        const successScreen = document.getElementById('successScreen');
        const phoneInput = document.getElementById('phoneNumber');
        const displayPhone = document.getElementById('displayPhone');
        const sendOtpBtn = document.getElementById('sendOtpBtn');
        const verifyOtpBtn = document.getElementById('verifyOtpBtn');
        const resendOtpBtn = document.getElementById('resendOtpBtn');
        const phoneMessage = document.getElementById('phoneMessage');
        const otpMessage = document.getElementById('otpMessage');
        const loader = document.getElementById('loader');
        const progress = document.querySelector('.progress');
        const stepPhone = document.getElementById('stepPhone');
        const stepOTP = document.getElementById('stepOTP');
        const stepSuccess = document.getElementById('stepSuccess');
        const countdownTimer = document.getElementById('countdownTimer');
        const resendTimer = document.getElementById('resendTimer');
        
        // OTP inputs
        const otpInputs = document.querySelectorAll('.otp-input');
        const otp1 = document.getElementById('otp1');
        const otp2 = document.getElementById('otp2');
        const otp3 = document.getElementById('otp3');
        const otp4 = document.getElementById('otp4');

        // Global variables
        let generatedOtp = '';
        let userPhoneNumber = '';
        let otpResendCountdown = 60;
        let otpResendTimer;
        
        // Fallback mode - when true, we'll use client-side OTP generation instead of API
        let fallbackMode = false;

        // Check if we have stored OTP in session storage (for refreshes)
        const storedOtp = sessionStorage.getItem('generatedOtp');
        const storedPhone = sessionStorage.getItem('userPhoneNumber');
        
        if (storedOtp && storedPhone) {
            generatedOtp = storedOtp;
            userPhoneNumber = storedPhone;
            phoneInput.value = userPhoneNumber;
            displayPhone.textContent = userPhoneNumber;
            
            // If we were in the OTP verification screen before refresh
            if (sessionStorage.getItem('currentScreen') === 'otp') {
                showScreen('otp');
            }
        }

        // OTP input functionality
        otpInputs.forEach((input, index) => {
            input.addEventListener('keyup', (e) => {
                const currentInput = input;
                const nextInput = input.nextElementSibling;
                const prevInput = input.previousElementSibling;

                // If value has been entered, move to next input
                if (currentInput.value.length === 1 && nextInput && nextInput.hasAttribute('id')) {
                    nextInput.focus();
                }

                // If backspace is pressed, move to previous input
                if (e.key === 'Backspace' && prevInput && prevInput.hasAttribute('id')) {
                    prevInput.focus();
                }
                
                // Combine all values to check if complete
                let isComplete = true;
                otpInputs.forEach(input => {
                    if (input.value === '') {
                        isComplete = false;
                    }
                });
                
                // Enable/disable verify button based on completion
                verifyOtpBtn.disabled = !isComplete;
            });
            
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pastedData = e.clipboardData.getData('text').trim();
                
                if (pastedData.length === 4 && /^\d+$/.test(pastedData)) {
                    // If a 4-digit number is pasted, distribute it across inputs
                    for (let i = 0; i < 4; i++) {
                        otpInputs[i].value = pastedData[i];
                    }
                    verifyOtpBtn.disabled = false;
                }
            });
        });

        // Generate random OTP
        function generateOTP() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }

        // Show loader
        function showLoader() {
            loader.style.display = 'block';
        }

        // Hide loader
        function hideLoader() {
            loader.style.display = 'none';
        }

        // Show screen
        function showScreen(screenName) {
            // Update progress bar
            if (screenName === 'phone') {
                progress.style.width = '33%';
                stepPhone.classList.add('active');
                stepOTP.classList.remove('active', 'completed');
                stepSuccess.classList.remove('active', 'completed');
                phoneScreen.classList.add('active');
                otpScreen.classList.remove('active');
                successScreen.classList.remove('active');
            } else if (screenName === 'otp') {
                progress.style.width = '66%';
                stepPhone.classList.remove('active');
                stepPhone.classList.add('completed');
                stepOTP.classList.add('active');
                stepSuccess.classList.remove('active', 'completed');
                phoneScreen.classList.remove('active');
                otpScreen.classList.add('active');
                successScreen.classList.remove('active');
                // Focus on first OTP input
                setTimeout(() => {
                    otp1.focus();
                }, 300);
                // Start resend countdown
                startResendTimer();
            } else if (screenName === 'success') {
                progress.style.width = '100%';
                stepPhone.classList.remove('active');
                stepPhone.classList.add('completed');
                stepOTP.classList.remove('active');
                stepOTP.classList.add('completed');
                stepSuccess.classList.add('active');
                phoneScreen.classList.remove('active');
                otpScreen.classList.remove('active');
                successScreen.classList.add('active');
                
                // Redirect to home page after success
                setTimeout(() => {
                    window.location.href = "home.html";
                }, 3000);
            }
            
            // Store current screen in session storage
            sessionStorage.setItem('currentScreen', screenName);
        }

        // Show message
        function showMessage(element, text, isError = false) {
            element.textContent = text;
            element.className = 'message ' + (isError ? 'error' : 'success');
            element.style.display = 'block';
            
            // Auto hide message after 5 seconds
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }
        
        // Start resend timer
        function startResendTimer() {
            // Reset timer
            clearInterval(otpResendTimer);
            otpResendCountdown = 60;
            countdownTimer.textContent = otpResendCountdown;
            resendTimer.style.display = 'block';
            resendOtpBtn.disabled = true;
            
            otpResendTimer = setInterval(() => {
                otpResendCountdown--;
                countdownTimer.textContent = otpResendCountdown;
                
                if (otpResendCountdown <= 0) {
                    clearInterval(otpResendTimer);
                    resendTimer.style.display = 'none';
                    resendOtpBtn.disabled = false;
                }
            }, 1000);
        }

        // Send OTP
        sendOtpBtn.addEventListener('click', function(e) {
            e.preventDefault();
            userPhoneNumber = phoneInput.value.trim();
            
            if (!userPhoneNumber) {
                showMessage(phoneMessage, 'Please enter your phone number', true);
                return;
            }

            // Generate OTP
            generatedOtp = generateOTP();
            console.log("Generated OTP for testing:", generatedOtp);
            
            // Store values in session storage
            sessionStorage.setItem('generatedOtp', generatedOtp);
            sessionStorage.setItem('userPhoneNumber', userPhoneNumber);
            
            // Update display phone number
            displayPhone.textContent = userPhoneNumber;
            
            // Show loader
            showLoader();
            
            if (fallbackMode) {
                // Use client-side OTP in fallback mode
                setTimeout(() => {
                    hideLoader();
                    showScreen('otp');
                }, 1000);
                return;
            }
            
            // Try sending via API
            try {
                // Create the URL with parameters
                const apiUrl = new URL('http://localhost:8000/api/receive-message/');
                apiUrl.searchParams.append('virtual_number', userPhoneNumber);
                apiUrl.searchParams.append('sender_name', 'shopeasy');
                apiUrl.searchParams.append('message', 'Your ShopEasy verification code is ' + generatedOtp);
                
                // Create a new XMLHttpRequest object
                const xhr = new XMLHttpRequest();
                
                // Set up the request
                xhr.open('GET', apiUrl.toString(), true);
                
                // Set a timeout
                xhr.timeout = 5000;
                
                // Set up event handlers
                xhr.onload = function() {
                    hideLoader();
                    if (xhr.status >= 200 && xhr.status < 300) {
                        console.log('Success:', xhr.responseText);
                        showScreen('otp');
                    } else {
                        console.error('Error:', xhr.status, xhr.statusText);
                        // Specific handling for 400 Bad Request - likely an invalid number
                        if (xhr.status === 400) {
                            showMessage(phoneMessage, 'Invalid number. Please check and try again.', true);
                        } else {
                            handleApiError();
                        }
                    }
                };
                
                xhr.onerror = function() {
                    console.error('Request failed');
                    hideLoader();
                    handleApiError();
                };
                
                xhr.ontimeout = function() {
                    console.error('Request timed out');
                    hideLoader();
                    handleApiError();
                };
                
                // Send the request
                xhr.send();
                
            } catch (error) {
                console.error('Error in try/catch:', error);
                hideLoader();
                handleApiError();
            }
        });
        
        // Resend OTP
        resendOtpBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Generate new OTP
            generatedOtp = generateOTP();
            console.log("Resent OTP for testing:", generatedOtp);
            
            // Store in session storage
            sessionStorage.setItem('generatedOtp', generatedOtp);
            
            // Show loader
            showLoader();
            
            if (fallbackMode) {
                // Use client-side OTP in fallback mode
                setTimeout(() => {
                    hideLoader();
                    showMessage(otpMessage, 'OTP has been resent');
                    startResendTimer();
                }, 1000);
                return;
            }
            
            // Try sending via API
            try {
                const apiUrl = new URL('http://localhost:8000/api/receive-message/');
                apiUrl.searchParams.append('virtual_number', userPhoneNumber);
                apiUrl.searchParams.append('sender_name', 'shopeasy');
                apiUrl.searchParams.append('message', 'Your ShopEasy verification code is ' + generatedOtp);
                
                const xhr = new XMLHttpRequest();
                xhr.open('GET', apiUrl.toString(), true);
                xhr.timeout = 5000;
                
                xhr.onload = function() {
                    hideLoader();
                    if (xhr.status >= 200 && xhr.status < 300) {
                        showMessage(otpMessage, 'OTP has been resent');
                        startResendTimer();
                    } else {
                        if (xhr.status === 400) {
                            showMessage(otpMessage, 'Failed to resend. Invalid number.', true);
                        } else {
                            showMessage(otpMessage, 'Failed to resend OTP. Using previous code.', true);
                        }
                    }
                };
                
                xhr.onerror = function() {
                    hideLoader();
                    showMessage(otpMessage, 'Network error. Using previous code.', true);
                };
                
                xhr.ontimeout = function() {
                    hideLoader();
                    showMessage(otpMessage, 'Request timed out. Using previous code.', true);
                };
                
                xhr.send();
                
            } catch (error) {
                hideLoader();
                showMessage(otpMessage, 'Error resending OTP. Using previous code.', true);
            }
        });

        // Handle API errors by switching to fallback mode
        function handleApiError() {
            fallbackMode = true;
            showMessage(phoneMessage, 'API connection failed. Using local OTP mode.', true);
            setTimeout(() => {
                showScreen('otp');
            }, 1000);
        }

        // Verify OTP
        verifyOtpBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Combine OTP digits
            const enteredOtp = otp1.value + otp2.value + otp3.value + otp4.value;
            
            if (enteredOtp.length !== 4) {
                showMessage(otpMessage, 'Please enter the complete OTP', true);
                return;
            }

            console.log("Entered OTP:", enteredOtp);
            console.log("Generated OTP:", generatedOtp);

            if (enteredOtp === generatedOtp) {
                showMessage(otpMessage, 'OTP verified successfully');
                
                // Store verification status
                sessionStorage.setItem('isVerified', 'true');
                
                // Send welcome & marketing messages with delays
                sendMarketingMessages();
                
                // Show success screen
                setTimeout(function() {
                    showScreen('success');
                }, 1000);
            } else {
                showMessage(otpMessage, 'Incorrect OTP. Please try again.', true);
                // Clear inputs for retry
                otpInputs.forEach(input => {
                    input.value = '';
                });
                otp1.focus();
            }
        });
        
        // Send marketing messages
        function sendMarketingMessages() {
            if (fallbackMode) return;
            
            try {
                // Welcome message
                setTimeout(() => {
                    sendMessageToAPI('Welcome to ShopEasy! Shop the best deals with free shipping on orders above $25.');
                }, 120000); // 2 minutes
                
                // Offer message
                setTimeout(() => {
                    sendMessageToAPI('SPECIAL OFFER: Use code WELCOME20 for 20% OFF on your first purchase!');
                }, 300000); // 5 minutes
                
                // Mega sale message
                setTimeout(() => {
                    sendMessageToAPI('ðŸ”¥ MEGA SALE ALERT! Up to 70% OFF on electronics, fashion, and home goods. Shop now!');
                }, 480000); // 8 minutes
            } catch (error) {
                console.error('Error scheduling marketing messages:', error);
            }
        }
        
        // Send message via API
        function sendMessageToAPI(messageText) {
            const apiUrl = new URL('http://localhost:8000/api/receive-message/');
            apiUrl.searchParams.append('virtual_number', userPhoneNumber);
            apiUrl.searchParams.append('sender_name', 'shopeasy');
            apiUrl.searchParams.append('message', messageText);
            
            fetch(apiUrl.toString())
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(data => {
                    console.log('Marketing message sent:', messageText);
                })
                .catch(error => {
                    console.error('Error sending marketing message:', error);
                });
        }
        
        // Auto-tab between OTP inputs
        otpInputs.forEach((input, index) => {
            // Only allow numbers
            input.addEventListener('input', function() {
                this.value = this.value.replace(/[^0-9]/g, '');
            });
            
            // Move to next input when digit entered
            input.addEventListener('keyup', function(e) {
                if (this.value && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
            });
            
            // Move to previous input on backspace
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && !this.value && index > 0) {
                    otpInputs[index - 1].focus();
                }
            });
        });

        // Add event listener for Enter key
        phoneInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendOtpBtn.click();
            }
        });
    </script>
</body>
</html>